## Flink ClickHouse Sinkï¼šç”Ÿäº§çº§é«˜å¯ç”¨å†™å…¥æ–¹æ¡ˆ

[Flink ClickHouse Sink ç”Ÿäº§çº§é«˜å¯ç”¨å†™å…¥æ–¹æ¡ˆ](https://mp.weixin.qq.com/s/DLFf7Z4DYPHV0PSXaA023g)

### ç›®å½•
ä¸€ã€èƒŒæ™¯ä¸ç—›ç‚¹

    1.ä¸šåŠ¡åœºæ™¯

    2.å¼€æº Flink ClickHouse Sink çš„ç—›ç‚¹

    3.ç”Ÿäº§çº§æ–¹æ¡ˆçš„æ ¸å¿ƒæ”¹è¿›

    4.æŠ€æœ¯æ–¹æ¡ˆæ¦‚è§ˆ

äºŒã€æ ¸å¿ƒæ¶æ„è®¾è®¡

    1.æ¶æ„å›¾

    2.æ ¸å¿ƒç»„ä»¶

    3.æ ¸å¿ƒæµç¨‹

ä¸‰ã€æœ¬åœ°è¡¨ vs åˆ†å¸ƒå¼è¡¨å†™å…¥

    1.ClickHouse è¡¨ç»“æ„è¯´æ˜

    2.HikariCP è¿æ¥æ± é…ç½®

    3.ClickHouseLocalWriterï¼šåŠ¨æ€èŠ‚ç‚¹å‘ç°

    4.é›†ç¾¤èŠ‚ç‚¹åŠ¨æ€å‘ç°ï¼ˆClusterIpsUtilsï¼‰

    5.è´Ÿè½½å‡è¡¡ä¼˜åŒ–

å››ã€æ”¯æŒåˆ†è¡¨ç­–ç•¥

    1.åˆ†ç‰‡ç­–ç•¥æŠ½è±¡

    2.æ—¥å¿—åˆ†ç‰‡å®ç°

    3.æŒ‰è¡¨ï¼ˆåº”ç”¨ï¼‰ç»´åº¦çš„ç¼“å†²åŒº

äº”ã€æ”’æ‰¹ä¸å†…å­˜æ§åˆ¶

    1.åŒè§¦å‘æœºåˆ¶

    2.æ‰¹æ¬¡å¤§å°è®¡ç®—

    3.å¸¦éšæœºæŠ–åŠ¨çš„è¶…æ—¶

    4.é…ç½®ç¤ºä¾‹

å…­ã€å†™å…¥é™æµä¸æµé‡æ§åˆ¶

    1.æœ‰ç•Œé˜Ÿåˆ—è®¾è®¡

    2.çº¿ç¨‹æ± å¹¶å‘æ§åˆ¶

    3.WriterTask æ¶ˆè´¹é€»è¾‘

    4.é…ç½®å‚æ•°

ä¸ƒã€é‡è¯•æœºåˆ¶ä¸è¶…æ—¶æ§åˆ¶

    1.Future è¶…æ—¶æ§åˆ¶

    2.é‡è¯•é€»è¾‘

    3.é‡è¯•æ§åˆ¶é€»è¾‘

    4.å¼‚å¸¸èŠ‚ç‚¹å‰”é™¤

    5.é‡è¯•æµç¨‹å›¾

å…«ã€å¼‚å¸¸å¤„ç†æ¨¡å¼

    1.ä¸¤ç§ Sink æ¨¡å¼

    2.UnexceptionableSinkï¼ˆå¿½ç•¥å¼‚å¸¸ - At-Most-Onceï¼‰

    3.ExceptionsThrowableSinkï¼ˆæŠ›å‡ºå¼‚å¸¸ - At-Least-Onceï¼‰

    4.Future æ¸…ç†ç­–ç•¥ä¸å¹¶å‘æ§åˆ¶

ä¹ã€Checkpoint è¯­ä¹‰ä¿è¯

    1.ä¸ºä»€ä¹ˆ Checkpoint æ—¶å¿…é¡» Flushï¼Ÿ

    2.Flush å®ç°ä¸å¹¶å‘åè°ƒ

    3.ç­‰å¾…æ‰€æœ‰ Future å®Œæˆ

    4.ä¸‰ç§ Flush è§¦å‘æ–¹å¼å¯¹æ¯”

    5. Checkpoint å‚æ•°é…ç½®

    6.è¯­ä¹‰ä¿è¯

åã€æœ€ä½³å®è·µä¸è°ƒä¼˜

    1.ç”Ÿäº§é…ç½®

    2.æ€§èƒ½è°ƒä¼˜

    3.æ•…éšœæ’æŸ¥

åä¸€ã€æ€»ç»“

    1.æŠ€æœ¯äº®ç‚¹

    2.Checkpoint è¯­ä¹‰

    3.ç”Ÿäº§å»ºè®®


> ä¸€ èƒŒæ™¯ä¸ç—›ç‚¹
- 1.1 ä¸šåŠ¡åœºæ™¯

>> åœ¨å®æ—¶å¤§æ•°æ®å¤„ç†åœºæ™¯ä¸­ï¼ŒFlink + ClickHouse çš„ç»„åˆè¢«å¹¿æ³›åº”ç”¨äºï¼š

>> æ—¥å¿—å¤„ç†ï¼šæµ·é‡åº”ç”¨æ—¥å¿—å®æ—¶å†™å…¥åˆ†æåº“ã€‚

>> ç›‘æ§åˆ†æï¼šä¸šåŠ¡æŒ‡æ ‡ã€APM æ•°æ®çš„å®æ—¶èšåˆã€‚



>> è¿™äº›åœºæ™¯çš„å…±åŒç‰¹ç‚¹ï¼š

>> æ•°æ®é‡å¤§ï¼šç™¾ä¸‡çº§ TPSï¼Œå³°å€¼å¯è¾¾åƒä¸‡çº§ã€‚

>> å†™å…¥å»¶è¿Ÿæ•æ„Ÿï¼šéœ€è¦ç§’çº§å¯è§ã€‚

>> æ•°æ®å‡†ç¡®æ€§è¦æ±‚é«˜ï¼šä¸å…è®¸æ•°æ®ä¸¢å¤±ã€‚

>> å¤šè¡¨å†™å…¥ï¼šä¸åŒæ•°æ®æ ¹æ®åˆ†è¡¨ç­–ç•¥å†™å…¥ä¸åŒçš„è¡¨ã€‚

- 1.2 å¼€æº Flink ClickHouse Sink çš„ç—›ç‚¹:

>> Flink å®˜æ–¹æä¾›çš„ ClickHouse Sinkï¼ˆflink-connector-jdbcï¼‰åœ¨ç”Ÿäº§ç¯å¢ƒä¸­å­˜åœ¨ä»¥ä¸‹ä¸¥é‡é—®é¢˜
> >
> > ç—›ç‚¹ä¸€ï¼šç¼ºä¹åŸºäºæ•°æ®é‡çš„æ”’æ‰¹æœºåˆ¶
```

// Flink å®˜æ–¹ JDBC Sink çš„å®ç°
public class JdbcSink<T> extends RichSinkFunction<T> {
    private final int batchSize;  // å›ºå®šæ‰¹æ¬¡å¤§å°
    @Override
    public void invoke(T value, Context context) {
        bufferedValues.add(value);
        if (bufferedValues.size() >= batchSize) {
            // åªèƒ½åŸºäºè®°å½•æ•°æ”’æ‰¹ï¼Œæ— æ³•åŸºäºæ•°æ®é‡
            flush();
        }
    }

```

>> å¸¦æ¥çš„é—®é¢˜ï¼š
> >
> > 1.å†…å­˜å ç”¨ä¸å¯æ§ï¼š100 æ¡ 1KB çš„æ—¥å¿—å’Œ 100 æ¡ 10MB çš„æ—¥å¿—å ç”¨å†…å­˜å·®è· 100 å€
> >
> > 2.OOM é£é™©é«˜ï¼šå¤§æ—¥å¿—è®°å½•ï¼ˆå¦‚å †æ ˆè½¬å‚¨ï¼‰ä¼šè¿…é€Ÿæ’‘çˆ†å†…å­˜
> >
> > 3.å†™å…¥æ€§èƒ½å·®ï¼šæ— æ³•æ ¹æ®è®°å½•å¤§å°åŠ¨æ€è°ƒæ•´æ‰¹æ¬¡ï¼Œå¯¼è‡´å°è®°å½•æ‰¹æ¬¡è¿‡å¤§æµªè´¹ç½‘ç»œå¼€é”€

>> ç—›ç‚¹äºŒï¼šæ— æ³•æ”¯æŒåŠ¨æ€è¡¨ç»“æ„
> >
> > é—®é¢˜è¡¨ç°ï¼š
> >
```

// Flink å®˜æ–¹ Sink åªèƒ½å†™å…¥å›ºå®šè¡¨
public class JdbcSink {
    private final String sql;  // å›ºå®šçš„ INSERT SQL
    public JdbcSink(String jdbcUrl, String sql, ...) {
        this.sql = sql;  // ç¡¬ç¼–ç çš„è¡¨ç»“æ„
    }
}
```
>> å¸¦æ¥çš„é—®é¢˜ï¼š
> >
> > 1.å¤šåº”ç”¨æ— æ³•éš”ç¦»ï¼šæ‰€æœ‰åº”ç”¨çš„æ•°æ®å†™å…¥åŒä¸€å¼ è¡¨ï¼Œé€šè¿‡ç‰¹å®šåˆ†è¡¨ç­–ç•¥åŒºåˆ†
> >
> > 2.æ‰©å±•æ€§å·®ï¼šæ–°å¢åº”ç”¨éœ€è¦æ‰‹åŠ¨å»ºè¡¨ï¼Œæ— æ³•åŠ¨æ€è·¯ç”±
> >
> > 3.æ€§èƒ½ç“¶é¢ˆï¼šå•è¡¨æ•°æ®é‡è¿‡å¤§ï¼ˆç™¾äº¿çº§ï¼‰ï¼ŒæŸ¥è¯¢å’Œå†™å…¥æ€§èƒ½æ€¥å‰§ä¸‹é™

>> ç—›ç‚¹ä¸‰ï¼šåˆ†å¸ƒå¼è¡¨å†™å…¥æ€§èƒ½é—®é¢˜
>> é—®é¢˜è¡¨ç°ï¼š
> >
```
// å¤§å¤šæ•°ç”Ÿäº§å®ç°ç›´æ¥å†™å…¥åˆ†å¸ƒå¼è¡¨
INSERT INTO distributed_table_all VALUES (...)
```
>> ClickHouse åˆ†å¸ƒå¼è¡¨çš„å·¥ä½œåŸç†ï¼š

![image_294](../image_294.png)

>>å¸¦æ¥çš„é—®é¢˜ï¼š
> >
> > 1.ç½‘ç»œå¼€é”€å¤§ï¼šæ•°æ®éœ€è¦ç»è¿‡åˆ†å¸ƒå¼è¡¨å±‚è½¬å‘ï¼Œå»¶è¿Ÿå¢åŠ 
> >
> > 2.å†™å…¥æ€§èƒ½å·®ï¼šåˆ†å¸ƒå¼è¡¨å¢åŠ äº†è·¯ç”±å’Œè½¬å‘é€»è¾‘ï¼Œååé‡é™ä½
> >
> > 3.çƒ­ç‚¹é—®é¢˜ï¼šæ‰€æœ‰æ•°æ®å…ˆåˆ°åˆ†å¸ƒå¼è¡¨èŠ‚ç‚¹ï¼Œå†è½¬å‘ï¼Œé€ æˆå•ç‚¹ç“¶é¢ˆ

>> ç”Ÿäº§çº§æ–¹æ¡ˆçš„æ ¸å¿ƒæ”¹è¿›
> >
> > é’ˆå¯¹ä»¥ä¸Šç—›ç‚¹ï¼Œæœ¬æ–¹æ¡ˆæä¾›äº†ä»¥ä¸‹æ ¸å¿ƒæ”¹è¿›ï¼š
> >
> > æ”¹è¿›ä¸€ï¼šåŸºäºæ•°æ®é‡çš„æ”’æ‰¹æœºåˆ¶
> >
```
public class ClickHouseSinkCounter {
    private Long metaSize;  // ç´¯è®¡æ•°æ®é‡ï¼ˆå­—èŠ‚ï¼‰
    public void add(LogModel value) {
        this.values.add(value);
        this.metaSize += value.getMetaSize();  // ç´¯åŠ æ•°æ®é‡
    }
}
// è§¦å‘æ¡ä»¶
private boolean flushCondition(String application) {
    return checkMetaSize(application)  // metaSize >= 10000 å­—èŠ‚
        || checkTime(application);     // æˆ–è¶…æ—¶ 30 ç§’
}
```

>> ä¼˜åŠ¿ï¼š
> >
> > å†…å­˜å¯æ§ï¼šæ ¹æ®æ•°æ®é‡è€Œéè®°å½•æ•°æ”’æ‰¹ã€‚
> >
> > ç²¾ç¡®æ§åˆ¶ï¼š1KB çš„è®°å½•æ”’ 10000 æ¡ = 10MBï¼Œ1MB çš„è®°å½•æ”’ 10 æ¡ = 10MB
> >
> > é¿å…OOMï¼šå¤§æ—¥å¿—è®°å½•ä¸ä¼šæ’‘çˆ†å†…å­˜
> >

>> æ”¹è¿›äºŒï¼šåŠ¨æ€è¡¨ç»“æ„ä¸åˆ†ç‰‡ç­–ç•¥
```

public abstract class ClickHouseShardStrategy<T> {
    public abstract String getTableName(T data);
}
//æ—¥å¿—ä¾§å®ç°ä¸ºåº”ç”¨çº§åˆ†è¡¨
public class LogClickHouseShardStrategy extends ClickHouseShardStrategy<String> {
    @Override
    public String getTableName(String application) {
        // åŠ¨æ€è·¯ç”±ï¼šorder-service â†’ tb_logs_order_service
        return String.format("tb_logs_%s", application);
    }
}
```

>> ä¼˜åŠ¿ï¼š
> > åº”ç”¨éš”ç¦»ï¼šæ—¥å¿—ä¾§å†…ç½®åº”ç”¨çº§åˆ†è¡¨ï¼Œæ¯ä¸ªåº”ç”¨ç‹¬ç«‹åˆ†è¡¨
> >
> > åŠ¨æ€è·¯ç”±ï¼šæ ¹æ® application è‡ªåŠ¨è·¯ç”±åˆ°ç›®æ ‡è¡¨
> >
> > æ‰©å±•æ€§å¼ºï¼šæ–°å¢åº”ç”¨æ— éœ€æ‰‹åŠ¨å»ºè¡¨ï¼ˆé…åˆ ClickHouse è‡ªåŠ¨å»ºè¡¨ï¼‰

>> æ”¹è¿›ä¸‰ï¼šæœ¬åœ°è¡¨å†™å…¥ + åŠ¨æ€èŠ‚ç‚¹å‘ç°
```
public class ClickHouseLocalWriter extends ClickHouseWriter {
    // ç›´æ¥å†™æœ¬åœ°è¡¨ï¼Œé¿å…åˆ†å¸ƒå¼è¡¨è½¬å‘
    private final ConcurrentMap<String, HikariDataSource> dataSourceMap;
    @Override
    public HikariDataSource getNextDataSource(Set<String> exceptionHosts) {
        // 1. åŠ¨æ€è·å–é›†ç¾¤èŠ‚ç‚¹åˆ—è¡¨
        List<String> healthyHosts = getHealthyHosts(exceptionHosts);
        // 2. éšæœºé€‰æ‹©å¥åº·èŠ‚ç‚¹
        return dataSourceMap.get(healthyHosts.get(random.nextInt(size)));
    }
}
```
>> ä¼˜åŠ¿ï¼š
> >
> > æ€§èƒ½æå‡ï¼šç›´æ¥å†™æœ¬åœ°è¡¨ï¼Œé¿å…ç½‘ç»œè½¬å‘ã€‚
> >
> > é«˜å¯ç”¨ï¼šåŠ¨æ€èŠ‚ç‚¹å‘ç° + æ•…éšœèŠ‚ç‚¹å‰”é™¤ã€‚
> >
> > è´Ÿè½½å‡è¡¡ï¼šéšæœºé€‰æ‹© + Shuffle åˆå§‹åŒ–ã€‚

- æŠ€æœ¯æ–¹æ¡ˆæ¦‚è§ˆ
>> åŸºäºä»¥ä¸Šæ”¹è¿›ï¼Œæœ¬æ–¹æ¡ˆæä¾›äº†ä»¥ä¸‹æ ¸å¿ƒèƒ½åŠ›ï¼š
> >
> > 1.æœ¬åœ°è¡¨/åˆ†å¸ƒå¼è¡¨å†™å…¥ï¼šæ€§èƒ½ä¼˜åŒ–ä¸é«˜å¯ç”¨å¹³è¡¡
> >
> > 2.åˆ†ç‰‡ç­–ç•¥ï¼šæŒ‰åº”ç”¨ç»´åº¦è·¯ç”±ä¸éš”ç¦»
> >
> > 3.æ”’æ‰¹ä¸å†…å­˜æ§åˆ¶ï¼šåŒè§¦å‘æœºåˆ¶ï¼ˆæ•°æ®é‡ + è¶…æ—¶ï¼‰
> >
> > 4.æµé‡æ§åˆ¶ä¸é™æµï¼šæœ‰ç•Œé˜Ÿåˆ— + è¿æ¥æ± 
> >
> > 5.å¥å£®çš„é‡è¯•æœºåˆ¶ï¼šé€’å½’é‡è¯• + æ•…éšœèŠ‚ç‚¹å‰”é™¤
> >
> > 6.Checkpoint è¯­ä¹‰ä¿è¯ï¼šAt-Least-Once æ•°æ®ä¸€è‡´æ€§ã€‚

- æ ¸å¿ƒæ¶æ„è®¾è®¡

![image_295](../image_295.png)

>> æ ¸å¿ƒç»„ä»¶
![image_296](../image_296.png)

>> æ ¸å¿ƒæµç¨‹

![ce9bb3661ecb6bc6f34832b1587486b1](../ce9bb3661ecb6bc6f34832b1587486b1.png)

> æœ¬åœ°è¡¨ vs åˆ†å¸ƒå¼è¡¨å†™å…¥
![779945303abc66140c1a5873328eef77](../779945303abc66140c1a5873328eef77.png)

>> ClickHouse è¡¨ç»“æ„è¯´æ˜
>>
>> ClickHouse æ¨èç›´æ¥å†™æœ¬åœ°è¡¨ï¼ŒåŸå› ï¼š
> >
> > 1.å†™å…¥æ€§èƒ½ï¼šé¿å…åˆ†å¸ƒå¼è¡¨çš„ç½‘ç»œåˆ†å‘ã€‚
> >
> > 2.æ•°æ®ä¸€è‡´æ€§ï¼šç›´æ¥å†™å…¥ç›®æ ‡èŠ‚ç‚¹ï¼Œå‡å°‘ä¸­é—´ç¯èŠ‚æ•…éšœç‚¹ï¼Œæ¯”åˆ†å¸ƒå¼è¡¨å†™å…¥æ›´å®‰å…¨ï¼Œåˆ©äºå·¥ç¨‹åŒ–
> >
> > 3.è´Ÿè½½å‡è¡¡ï¼šå®¢æˆ·ç«¯è·¯ç”±å®ç°è´Ÿè½½åˆ†æ•£

```

-- æœ¬åœ°è¡¨ï¼ˆå®é™…å­˜å‚¨æ•°æ®ï¼‰
CREATE TABLE tb_logs_local ON CLUSTER 'default' (
    application String,
    environment String,
    message String,
    log_time DateTime
) ENGINE = MergeTree()
PARTITION BY toYYYYMM(log_time)
ORDER BY (application, log_time);
-- åˆ†å¸ƒå¼è¡¨ï¼ˆé€»è¾‘è§†å›¾ï¼Œä¸å­˜å‚¨æ•°æ®ï¼‰
CREATE TABLE tb_logs_all ON CLUSTER 'default' AS tb_logs_local
ENGINE = Distributed('default', dw_log, tb_logs_local, cityHash64(application));
```

- HikariCP è¿æ¥æ± é…ç½®
```

// HikariCP è¿æ¥æ± é…ç½®
public class ClickHouseDataSourceUtils {
    private static HikariConfig getHikariConfig(DataSourceImpl dataSource) {
        HikariConfig config = new HikariConfig();
        config.setConnectionTimeout(30000L);    // è¿æ¥è¶…æ—¶ 30s
        config.setMaximumPoolSize(20);          // æœ€å¤§è¿æ¥æ•° 20
        config.setMinimumIdle(2);               // æœ€å°ç©ºé—² 2
        config.setDataSource(dataSource);
        return config;
    }
    private static Properties getClickHouseProperties(ClickHouseSinkCommonParams params) {
        Properties props = new Properties();
        props.setProperty("user", params.getUser());
        props.setProperty("password", params.getPassword());
        props.setProperty("database", params.getDatabase());
        props.setProperty("socket_timeout", "180000");      // Socket è¶…æ—¶ 3 åˆ†é’Ÿ
        props.setProperty("socket_keepalive", "true");      // ä¿æŒè¿æ¥
        props.setProperty("http_connection_provider", "APACHE_HTTP_CLIENT");
        return props;
    }
}
```

>> é…ç½®è¯´æ˜ï¼š
> >
> > maxPoolSize=20ï¼šæ¯ä¸ª ClickHouse èŠ‚ç‚¹æœ€å¤š 20 ä¸ªè¿æ¥
> >
> > minIdle=2ï¼šä¿æŒ 2 ä¸ªç©ºé—²è¿æ¥ï¼Œé¿å…é¢‘ç¹åˆ›å»º
> >
> > socket_timeout=180sï¼šSocket è¶…æ—¶ 3 åˆ†é’Ÿï¼Œé˜²æ­¢é•¿æ—¶é—´æŸ¥è¯¢é˜»å¡ã€‚

> ClickHouseLocalWriterï¼šåŠ¨æ€èŠ‚ç‚¹å‘ç°
```
public class ClickHouseLocalWriter extends ClickHouseWriter {
    // æœ¬åœ°èŠ‚ç‚¹ç¼“å­˜ï¼ŒæŒ‰ IP ç»´æŠ¤
    private final ConcurrentMap<String, HikariDataSource> dataSourceMap;
    // åŠ¨æ€è·å–é›†ç¾¤æœ¬åœ°è¡¨èŠ‚ç‚¹
    private final ClusterIpsUtils clusterIpsUtils;
    // IP å˜æ›´æ ‡å¿—ï¼ˆCAS é”ï¼Œé¿å…å¹¶å‘æ›´æ–°ï¼‰
    private static final AtomicBoolean IP_CHANGING = new AtomicBoolean(false);
    @Override
    public HikariDataSource getNextDataSource(Set<String> exceptionHosts) {
        // 1ï¸âƒ£ æ£€æµ‹é›†ç¾¤èŠ‚ç‚¹å˜åŒ–ï¼ˆé€šè¿‡ CAS é¿å…å¹¶å‘æ›´æ–°ï¼‰
        if (clusterIpsChanged() && IP_CHANGING.compareAndSet(false, true)) {
            try {
                ipChanged(); // åŠ¨æ€æ›´æ–° dataSourceMap
            } finally {
                IP_CHANGING.set(false);
            }
        }
        // 2ï¸âƒ£ è·å–å¼‚å¸¸èŠ‚ç‚¹åˆ—è¡¨ï¼ˆä» Redis + APM å®æ—¶æŸ¥è¯¢ï¼‰
        Set<String> exceptIps = clusterIpsUtils.getExceptIps();
        exceptIps.addAll(exceptionHosts);
        // 3ï¸âƒ£ è¿‡æ»¤å¥åº·èŠ‚ç‚¹ï¼Œéšæœºé€‰æ‹©
        List<String> healthyHosts = dataSourceMap.keySet().stream()
            .filter(host -> !exceptIps.contains(host))
            .collect(Collectors.toList());
        if (CollectionUtils.isEmpty(healthyHosts)) {
            throw new RuntimeException("Can't get datasource from local cache");
        }
        return dataSourceMap.get(healthyHosts.get(random.nextInt(healthyHosts.size())));
    }
    private void ipChanged() {
        List<String> clusterIps = clusterIpsUtils.getClusterIps();
        // æ–°å¢èŠ‚ç‚¹ï¼šè‡ªåŠ¨åˆ›å»ºè¿æ¥æ± 
        clusterIps.forEach(ip ->
            dataSourceMap.computeIfAbsent(ip, v ->
                createHikariDataSource(ip, port)
            )
        );
        // ç§»é™¤ä¸‹çº¿èŠ‚ç‚¹ï¼šå…³é—­è¿æ¥æ± 
        dataSourceMap.forEach((ip, ds) -> {
            if (!clusterIps.contains(ip)) {
                dataSourceMap.remove(ip);
                ds.close();
            }
        });
    }
}
```

>> æ ¸å¿ƒé€»è¾‘ï¼š
> > 1.åŠ¨æ€èŠ‚ç‚¹å‘ç°ï¼šä» system.clusters æŸ¥è¯¢æ‰€æœ‰èŠ‚ç‚¹
> >
> > 2.è‡ªåŠ¨æ‰©ç¼©å®¹ï¼šèŠ‚ç‚¹ä¸Šçº¿è‡ªåŠ¨åŠ å…¥ï¼Œä¸‹çº¿è‡ªåŠ¨å‰”é™¤
> >
> > 3.æ•…éšœèŠ‚ç‚¹å‰”é™¤ï¼šé€šè¿‡ APM ç›‘æ§ï¼Œè‡ªåŠ¨å‰”é™¤å¼‚å¸¸èŠ‚ç‚¹
> >
> > 4.è´Ÿè½½å‡è¡¡ï¼šéšæœºé€‰æ‹©å¥åº·èŠ‚ç‚¹ï¼Œé¿å…çƒ­ç‚¹

- é›†ç¾¤èŠ‚ç‚¹åŠ¨æ€å‘ç°ï¼ˆClusterIpsUtilsï¼‰
```
public class ClusterIpsUtils {
    // ä» system.clusters æŸ¥è¯¢æ‰€æœ‰èŠ‚ç‚¹
    private static final String QUERY_CLUSTER_IPS =
        "select host_address from system.clusters where cluster = 'default'";
    // LoadingCacheï¼šå®šæ—¶åˆ·æ–°èŠ‚ç‚¹åˆ—è¡¨ï¼ˆ1 å°æ—¶ï¼‰
    private final LoadingCache<String, List<String>> clusterIpsCache =
        CacheBuilder.newBuilder()
            .expireAfterAccess(10, TimeUnit.HOURS)
            .refreshAfterWrite(1, TimeUnit.HOURS)
            .build(CacheLoader.asyncReloading(new CacheLoader<>() {
                @Override
                public List<String> load(String dbName) {
                    return queryClusterIps();  // å®šæ—¶åˆ·æ–°èŠ‚ç‚¹åˆ—è¡¨
                }
            }));
    // å¼‚å¸¸èŠ‚ç‚¹ç¼“å­˜ï¼ˆ1 åˆ†é’Ÿåˆ·æ–°ï¼‰
    private final LoadingCache<String, FlinkExceptIpModel> exceptIpsCache =
        CacheBuilder.newBuilder()
            .refreshAfterWrite(1, TimeUnit.MINUTES)
            .build(CacheLoader.asyncReloading(new CacheLoader<>() {
                @Override
                public FlinkExceptIpModel load(String dbName) {
                    return queryExceptIp();  // ä» Redis + APM æŸ¥è¯¢å¼‚å¸¸èŠ‚ç‚¹
                }
            }));
}
```
>> å¼‚å¸¸èŠ‚ç‚¹ç›‘æ§ç­–ç•¥ï¼š
> >
> > ç£ç›˜ä½¿ç”¨ç‡ >= 90%ï¼šä» APM æŸ¥è¯¢ Prometheus æŒ‡æ ‡ï¼Œè‡ªåŠ¨åŠ å…¥é»‘åå•
> >
> > HTTP è¿æ¥æ•° >= 50ï¼šè¿æ¥æ•°è¿‡å¤šè¯´æ˜èŠ‚ç‚¹å‹åŠ›å¤§ï¼Œè‡ªåŠ¨åŠ å…¥é»‘åå•
> >
> > äººå·¥é…ç½®ï¼šé€šè¿‡ Redis é…ç½®æ‰‹åŠ¨å‰”é™¤èŠ‚ç‚¹

>> æ•°æ®æ¥æºï¼š
> > 1.ClickHouse system.clusters è¡¨ï¼šè·å–æ‰€æœ‰é›†ç¾¤èŠ‚ç‚¹
> >
> > 2.APM Prometheus æ¥å£ï¼šç›‘æ§èŠ‚ç‚¹å¥åº·çŠ¶æ€
> >
> > 3.Redis ç¼“å­˜ï¼šäººå·¥é…ç½®çš„å¼‚å¸¸èŠ‚ç‚¹

- è´Ÿè½½å‡è¡¡ä¼˜åŒ–
```
public class ClickHouseWriter {
    public <T> ClickHouseWriter(...) {
        // Shuffleï¼šéšæœºæ‰“ä¹±æ•°æ®æºé¡ºåº
        Collections.shuffle(clickHouseDataSources);
        this.clickHouseDataSources = clickHouseDataSources;
    }
    public HikariDataSource getNextDataSource(Set<String> exceptionHosts) {
        // è½®è¯¢ + éšæœºé€‰æ‹©ï¼ˆå·² shuffleï¼Œé¿å…çƒ­ç‚¹ï¼‰
        int current = this.currentRandom.getAndIncrement();
        if (current >= clickHouseDataSources.size()) {
            this.currentRandom.set(0);
        }
        return clickHouseDataSources.get(currentRandom.get());
    }
}
```

>> ä¼˜åŠ¿ï¼š
> >
> > åˆå§‹åŒ–æ—¶ shuffleï¼Œé¿å…æ‰€æœ‰ writer åŒæ—¶ä»ç¬¬ä¸€ä¸ªèŠ‚ç‚¹å¼€å§‹
> >
> > è½®è¯¢ + éšæœºé€‰æ‹©ï¼Œè´Ÿè½½åˆ†æ•£æ›´å‡åŒ€
> >
> > æ•…éšœèŠ‚ç‚¹è‡ªåŠ¨å‰”é™¤

- æ”¯æŒåˆ†è¡¨ç­–ç•¥
>> åˆ†ç‰‡ç­–ç•¥æŠ½è±¡:
```

public abstract class ClickHouseShardStrategy<T> {
    private String tableName;      // è¡¨åæ¨¡æ¿ï¼Œå¦‚ "tb_log_%s"
    private Integer tableCount;    // åˆ†è¡¨æ•°é‡
    // æ ¹æ®æ•°æ®å†³å®šç›®æ ‡è¡¨å
    public abstract String getTableName(T data);
}
```

>> æ—¥å¿—åˆ†ç‰‡å®ç°

```
public class LogClickHouseShardStrategy extends ClickHouseShardStrategy<String> {
    @Override
    public String getTableName(String application) {
        // è¡¨åæ ¼å¼ï¼štb_log_{application}
        // ä¾‹å¦‚ï¼šapplication = "order-service" -> table = "tb_log_order_service"
        return String.format(
            this.getTableName(),
            application.replace("-", "_").toLowerCase()
        );
    }
}
```

- æŒ‰è¡¨ï¼ˆåº”ç”¨ï¼‰ç»´åº¦çš„ç¼“å†²åŒº

>> æ—¥å¿—ä¾§ç»´åº¦é™çº§ä¸ºåº”ç”¨åç§°ç»´åº¦ç¼“å†²åŒºï¼Œå®åˆ™å› ä¸ºæŒ‰ç…§åº”ç”¨åˆ†è¡¨ï¼Œ
>> ä¸šåŠ¡æ–¹å¯ä½¿ç”¨è‡ªèº«åˆ†è¡¨ç­–ç•¥æºå¸¦è¡¨åå…ƒæ•°æ®ï¼Œè¿›è¡Œè¡¨ç»´åº¦ç¼“å†²

```
public class ClickHouseShardSinkBuffer {
    // æŒ‰ application åˆ†ç»„çš„ç¼“å†²åŒºï¼ˆConcurrentHashMap ä¿è¯å¹¶å‘å®‰å…¨ï¼‰
    private final ConcurrentHashMap<String, ClickHouseSinkCounter> localValues;
    public void put(LogModel value) {
        String application = value.getApplication();
        // 1ï¸âƒ£ æ£€æŸ¥æ˜¯å¦éœ€è¦ flush
        if (flushCondition(application)) {
            addToQueue(application); // è§¦å‘å†™å…¥
        }
        // 2ï¸âƒ£ æ·»åŠ åˆ°ç¼“å†²åŒºï¼ˆçº¿ç¨‹å®‰å…¨çš„ compute æ“ä½œï¼‰
        localValues.compute(application, (k, v) -> {
            if (v == null) v = new ClickHouseSinkCounter();
            v.add(value);
            return v;
        });
    }
    private void addToQueue(String application) {
        localValues.computeIfPresent(application, (k, v) -> {
            // æ·±æ‹·è´å¹¶æ¸…ç©ºï¼ˆé¿å…å¹¶å‘ä¿®æ”¹å¼‚å¸¸ï¼‰
            List<LogModel> deepCopy = v.copyValuesAndClear();
            // æ„é€ è¯·æ±‚ Blankï¼šapplication + targetTable + values
            String targetTable = shardStrategy.getTableName(application);
            ClickHouseRequestBlank blank = new ClickHouseRequestBlank(deepCopy, application, targetTable);
            // æ”¾å…¥é˜Ÿåˆ—
            writer.put(blank);
            return v;
        });
    }
}
```

>> æ ¸å¿ƒè®¾è®¡ï¼š
> >
> > 1.åº”ç”¨éš”ç¦»ï¼šæ¯ä¸ªè¡¨ï¼ˆåº”ç”¨ï¼‰ç‹¬ç«‹çš„ bufferï¼Œäº’ä¸å½±å“ã€‚
> >
> > 2.çº¿ç¨‹å®‰å…¨ï¼šä½¿ç”¨ ConcurrentHashMap.compute()ä¿è¯å¹¶å‘å®‰å…¨
> >
> > 3.æ·±æ‹·è´ï¼šList.copyOf() åˆ›å»ºä¸å¯å˜å‰¯æœ¬ï¼Œé¿å…å¹¶å‘ä¿®æ”¹
> >
> > 4.æ‰¹é‡æ¸…ç©ºï¼šä¸€æ¬¡æ€§å–å‡ºæ‰€æœ‰æ•°æ®ï¼Œæ¸…ç©ºè®¡æ•°å™¨

- æ”’æ‰¹ä¸å†…å­˜æ§åˆ¶
![2ba42890f7e6cc0a0770868029c91ff0](../2ba42890f7e6cc0a0770868029c91ff0.png)

>> åŒè§¦å‘æœºåˆ¶
```

public class ClickHouseShardSinkBuffer {
    private final int maxFlushBufferSize;  // æœ€å¤§æ‰¹æ¬¡å¤§å°ï¼ˆå¦‚ 10000ï¼‰
    private final long timeoutMillis;      // è¶…æ—¶æ—¶é—´ï¼ˆå¦‚ 30sï¼‰
    // è§¦å‘æ¡ä»¶æ£€æŸ¥ï¼ˆæ»¡è¶³ä»»ä¸€å³è§¦å‘ï¼‰
    private boolean flushCondition(String application) {
        return localValues.get(application) != null
            && (checkMetaSize(application) || checkTime(application));
    }
    // æ¡ä»¶1ï¼šè¾¾åˆ°æ‰¹æ¬¡å¤§å°
    private boolean checkMetaSize(String application) {
        return localValues.get(application).getMetaSize() >= maxFlushBufferSize;
    }
    // æ¡ä»¶2ï¼šè¶…æ—¶
    private boolean checkTime(String application) {
        long current = System.currentTimeMillis();
        return current - localValues.get(application).getInsertTime() > timeoutMillis;
    }
}
```

>> æ‰¹æ¬¡å¤§å°è®¡ç®—
```
public class ClickHouseSinkCounter {
    private final List<LogModel> values;
    private Long metaSize; // ç´¯è®¡çš„ metaSizeï¼ˆå­—èŠ‚ï¼‰
    public void add(LogModel value) {
        this.values.add(value);
        this.metaSize += value.getMetaSize(); // ç´¯åŠ  metaSize
    }
    public List<LogModel> copyValuesAndClear() {
        List<LogModel> logModels = List.copyOf(this.values); // æ·±æ‹·è´ï¼ˆä¸å¯å˜ï¼‰
        this.values.clear();
        this.metaSize = 0L;
        this.insertTime = System.currentTimeMillis();
        return logModels;
    }
}
```

>> å…³é”®ç‚¹ï¼š
> >
> > ä½¿ç”¨ metaSizeï¼ˆå­—èŠ‚æ•°ï¼‰è€Œéè®°å½•æ•°æ§åˆ¶æ‰¹æ¬¡ï¼Œå†…å­˜æ§åˆ¶æ›´ç²¾ç¡®
> >
> > List.copyOf() åˆ›å»ºä¸å¯å˜å‰¯æœ¬ï¼Œé¿å…å¹¶å‘ä¿®æ”¹
> >
> > æ¸…ç©ºåé‡ç½® insertTimeï¼Œä¿è¯è¶…æ—¶è§¦å‘å‡†ç¡®æ€§

- å¸¦éšæœºæŠ–åŠ¨çš„è¶…æ—¶

```

private final long timeoutMillis;
public ClickHouseShardSinkBuffer(..., int timeoutSec, ...) {
    // åŸºç¡€è¶…æ—¶ + 10% éšæœºæŠ–åŠ¨ï¼ˆé¿å…æƒŠç¾¤æ•ˆåº”ï¼‰
    this.timeoutMillis = TimeUnit.SECONDS.toMillis(timeoutSec)
                      + new SecureRandom().nextInt((int) (timeoutSec * 0.1 * 1000));
}
```

>> ç›®çš„ï¼šé¿å…å¤šä¸ªTM åŒæ—¶è§¦å‘ flushï¼Œé€ æˆå†™å…¥æµé‡å³°å€¼

>> é…ç½®ç¤ºä¾‹:
```

ClickHouseShardSinkBuffer.Builder
    .aClickHouseSinkBuffer()
    .withTargetTable("single_table")  //å•è¡¨æ—¶ï¼Œå¯ç›´æ¥ä½¿ç”¨æŒ‡å®šè¡¨å
    .withMaxFlushBufferSize(10000)  // å¯¹åº”å­—èŠ‚æ•°
    .withTimeoutSec(30)              // 30 ç§’è¶…æ—¶
    .withClickHouseShardStrategy(new LogClickHouseShardStrategy("table_prefix_%s", 8))  //åˆ†è¡¨ç­–ç•¥æ—¶ï¼Œä½¿ç”¨
    // åˆ†è¡¨ç­–ç•¥å¯æ ¹æ®ä¸šåŠ¡å®é™…æƒ…å†µè¿›è¡Œæ‰©å±•
    .build(clickHouseWriter);
```

- å†™å…¥é™æµä¸æµé‡æ§åˆ¶
>> æœ‰ç•Œé˜Ÿåˆ—è®¾è®¡
```

public class ClickHouseWriter {
    // æœ‰ç•Œé˜»å¡é˜Ÿåˆ—
    private final BlockingQueue<ClickHouseRequestBlank> commonQueue;
    public ClickHouseWriter(ClickHouseSinkCommonParams sinkParams, ...) {
        // é˜Ÿåˆ—æœ€å¤§å®¹é‡é…ç½®ï¼ˆé»˜è®¤ 10ï¼‰
        this.commonQueue = new LinkedBlockingQueue<>(sinkParams.getQueueMaxCapacity());
    }
    public void put(ClickHouseRequestBlank params) {
        unProcessedCounter.incrementAndGet();
        // put() æ–¹æ³•åœ¨é˜Ÿåˆ—æ»¡æ—¶ä¼šé˜»å¡ï¼Œå®ç°èƒŒå‹
        commonQueue.put(params);
    }
}
```

![image_297](../image_297.png)

>> çº¿ç¨‹æ± å¹¶å‘æ§åˆ¶
```

public class ClickHouseWriter {
    private final int numWriters; // å†™å…¥çº¿ç¨‹æ•°
    private ExecutorService service;
    private void buildComponents() {
        ThreadFactory threadFactory = ThreadUtil.threadFactory("clickhouse-writer");
        service = Executors.newFixedThreadPool(numWriters, threadFactory);
        // åˆ›å»ºå¤šä¸ª WriterTask å¹¶æäº¤
        for (int i = 0; i < numWriters; i++) {
            WriterTask task = new WriterTask(i, commonQueue, sinkParams, futures, unProcessedCounter);
            service.submit(task);
        }
    }
}
```

>> WriterTask æ¶ˆè´¹é€»è¾‘
```

class WriterTask implements Runnable {
    @Override
    public void run() {
        isWorking = true;
        while (isWorking || !queue.isEmpty()) {
            // poll() è¶…æ—¶è¿”å›ï¼ˆ100msï¼‰ï¼Œé¿å…æ— é™ç­‰å¾…
            ClickHouseRequestBlank blank = queue.poll(100, TimeUnit.MILLISECONDS);
            if (blank != null) {
                // åˆ›å»º Future å¹¶è®¾ç½®è¶…æ—¶ï¼ˆ3 åˆ†é’Ÿï¼‰
                CompletableFuture<Boolean> future = new CompletableFuture<>();
                future.orTimeout(3, TimeUnit.MINUTES);
                futures.add(future);
                try {
                    send(blank, future, new HashSet<>());
                } finally {
                    // final è¿›è¡ŒæœªçŸ¥å¼‚å¸¸å…œåº•ï¼Œé˜²æ­¢ä¸ºæ•è·å¼‚å¸¸é€ æˆfutureçŠ¶æ€ä¸å®Œæˆï¼Œæ°¸ä¹…é˜»å¡
                    if (!future.isDone()) {
                        future.completeExceptionally(new RuntimeException("Unknown exception"));
                    }
                    queueCounter.decrementAndGet();
                }
            }
        }
    }
}
```

>> é…ç½®å‚æ•°
![image_298](../image_298.png)

- é‡è¯•æœºåˆ¶ä¸è¶…æ—¶æ§åˆ¶
>> Future è¶…æ—¶æ§åˆ¶

```
class WriterTask implements Runnable {
    @Override
    public void run() {
        while (isWorking || !queue.isEmpty()) {
            ClickHouseRequestBlank blank = queue.poll(100, TimeUnit.MILLISECONDS);
            if (blank != null) {
                // åˆ›å»º Future å¹¶è®¾ç½® 3 åˆ†é’Ÿè¶…æ—¶
                CompletableFuture<Boolean> future = new CompletableFuture<>();
                future.orTimeout(3, TimeUnit.MINUTES); // é˜²æ­¢æ°¸ä¹…é˜»å¡
                futures.add(future);
                try {
                    send(blank, future, new HashSet<>());
                } finally {
                    if (!future.isDone()) {
                        future.completeExceptionally(new RuntimeException("Timeout"));
                    }
                    queueCounter.decrementAndGet();
                }
            }
        }
    }
}
```

>> è¶…æ—¶ç­–ç•¥ï¼š
> >
> > Future è¶…æ—¶ï¼š3 åˆ†é’Ÿï¼ˆorTimeoutï¼‰ã€‚
> >
> > Socket è¶…æ—¶ï¼š3 åˆ†é’Ÿï¼ˆsocket_timeout=180000ï¼‰
> >
> > è¿æ¥è¶…æ—¶ï¼š30 ç§’ï¼ˆconnectionTimeout=30000ï¼‰

- é‡è¯•é€»è¾‘
```

private void send(ClickHouseRequestBlank requestBlank,
                  CompletableFuture<Boolean> future,
                  Set<String> exceptHosts) {
    try {
        // 1. é€‰æ‹©æ•°æ®æºï¼ˆæ’é™¤å¼‚å¸¸èŠ‚ç‚¹ï¼‰
        HikariDataSource dataSource = getNextDataSource(exceptHosts);
        // 2. æ˜¾å¼è·å–è¿æ¥
        connection = dataSource.getConnection();
        preparedStatement = connection.prepareStatement(insertSql);
        // 3. æ‰¹é‡å†™å…¥
        for (LogModel value : requestBlank.getValues()) {
            sinkConverter.setParameters(preparedStatement, value);
            preparedStatement.addBatch();
        }
        boolean executed = preparedStatement.executeBatch()[0] > 0;
        if (!executed) {
            handleUnsuccessfulResponse(...);
        } else {
            future.complete(true);
        }
    } catch (Throwable e) {
        handleUnsuccessfulResponse(...); // é€’å½’é‡è¯•
    } finally {
        // æ˜¾å¼å…³é—­èµ„æºï¼ˆé˜²æ­¢è¿æ¥æ³„æ¼ï¼‰
        close(preparedStatement, connection);
    }
}
```

-  é‡è¯•æ§åˆ¶é€»è¾‘
```
private void handleUnsuccessfulResponse(..., Set<String> exceptHosts) {
    // æ£€æŸ¥ Future æ˜¯å¦å·²å®Œæˆï¼ˆé¿å…é‡å¤å®Œæˆï¼‰
    if (future.isDone()) {
        return;
    }
    if (attemptCounter >= maxRetries) {
        // è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°ï¼Œæ ‡è®°å¤±è´¥
        future.completeExceptionally(new RuntimeException("Max retries exceeded"));
    } else {
        // é€’å½’é‡è¯•
        requestBlank.incrementCounter();
        send(requestBlank, future, exceptHosts); // é€’å½’è°ƒç”¨ï¼Œæ’é™¤å¤±è´¥èŠ‚ç‚¹
    }
}
```

>> é‡è¯•ç­–ç•¥ï¼š
> >
> > 1.é€’å½’é‡è¯•ï¼šå¤±è´¥åé€’å½’è°ƒç”¨ï¼Œç›´åˆ°æˆåŠŸæˆ–è¾¾åˆ°æœ€å¤§æ¬¡æ•°
> >
> > 2.å¼‚å¸¸èŠ‚ç‚¹éš”ç¦»ï¼šæ¯æ¬¡é‡è¯•æ—¶æ’é™¤å¤±è´¥çš„èŠ‚ç‚¹ï¼ˆexceptHostsï¼‰
> >
> > 3.è¶…æ—¶æ§åˆ¶ï¼šFuture è¶…æ—¶ï¼ˆ3 åˆ†é’Ÿï¼‰é˜²æ­¢æ°¸ä¹…é˜»å¡

>> ä¸ºä»€ä¹ˆé€’å½’é‡è¯•æ˜¯æ›´å¥½çš„é€‰æ‹©

![image_299](../image_299.png)

>ä¿è¯ä¸€è‡´æ€§

```
 // ClickHouseWriter.java:139-158
  while (!futures.isEmpty() || unProcessedCounter.get() > 0) {
      CompletableFuture<Void> future = FutureUtil.allOf(futures);
      future.get(3, TimeUnit.MINUTES);  // é˜»å¡ç›´åˆ°å…¨éƒ¨å®Œæˆ
  }
```

>> Checkpoint æ—¶æ‰€æœ‰æ•°æ®è¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥
> >
> > é‡å¯åä¸ä¼šæœ‰éƒ¨åˆ†æ•°æ®é‡å¤çš„é—®é¢˜ã€‚

> ç®€å•å¯é 
>> ä»£ç é€»è¾‘æ¸…æ™°ã€‚
> >
> > å¯¹äºé˜Ÿåˆ—é‡è¯•ä¸”ä¸é‡å¤ï¼Œéœ€è¦å¤æ‚çš„äºŒé˜¶æ®µæäº¤ï¼ˆè¿™é‡Œæš‚ä¸å±•å¼€ï¼‰ï¼Œå¤§å¹…å¢åŠ ä»£ç å¤æ‚åº¦


> æ€§èƒ½å¯æ¥å—
```
// ClickHouseWriter.java:235
  future.orTimeout(3, TimeUnit.MINUTES);  // 3åˆ†é’Ÿè¶…æ—¶
```

>> è™½ç„¶é˜»å¡ï¼Œä½†æœ‰è¶…æ—¶ä¿æŠ¤ã€‚
> >
> > ClickHouse å†™å…¥é€šå¸¸å¾ˆå¿«ï¼ˆç§’çº§ï¼‰ã€‚
> >
> > ç½‘ç»œæ•…éšœæ—¶é‡è¯•ä¹Ÿåˆç†

> é¿å¼€æ•…éšœèŠ‚ç‚¹
```
// ClickHouseWriter.java:259-260
  HikariDataSource dataSource = getNextDataSource(exceptHosts);
```

>> é€’å½’æ—¶å¯ä»¥ä¼ é€’ exceptHosts
> >
> > è‡ªåŠ¨é¿å¼€å¤±è´¥çš„èŠ‚ç‚¹ã€‚
> >
> > æé«˜æˆåŠŸç‡

- å¼‚å¸¸èŠ‚ç‚¹å‰”é™¤
```
// ç‰¹æ®Šé”™è¯¯ç åˆ—è¡¨ï¼ˆè‡ªåŠ¨åŠ å…¥é»‘åå•ï¼‰
private final List<Integer> ignoreHostCodes = Arrays.asList(210, 1002);
public HikariDataSource getNextDataSource(Set<String> exceptionHosts) {
    if (CollectionUtils.isNotEmpty(exceptionHosts)) {
        // è¿‡æ»¤å¼‚å¸¸èŠ‚ç‚¹
        List<HikariDataSource> healthyHosts = clickHouseDataSources.stream()
            .filter(ds -> !exceptionHosts.contains(getHostFromUrl(ds)))
            .collect(Collectors.toList());
        if (CollectionUtils.isEmpty(healthyHosts)) {
            return null; // æ‰€æœ‰èŠ‚ç‚¹éƒ½å¼‚å¸¸
        }
        return healthyHosts.get(random.nextInt(healthyHosts.size()));
    }
    // æ­£å¸¸è½®è¯¢ï¼ˆå·² shuffleï¼Œé¿å…çƒ­ç‚¹ï¼‰
    return clickHouseDataSources.get(currentRandom.getAndIncrement() % size);
}
```

>> æ•…éšœèŠ‚ç‚¹å‰”é™¤ç­–ç•¥ï¼š
> >
> > 1.é”™è¯¯ç  210ï¼ˆç½‘ç»œå¼‚å¸¸ï¼‰ï¼šè‡ªåŠ¨åŠ å…¥é»‘åå•ã€‚
> >
> > 2.é”™è¯¯ç  1002ï¼ˆè¿æ¥æ± å¼‚å¸¸ï¼‰ï¼šè‡ªåŠ¨åŠ å…¥é»‘åå•
> >
> > 3.APM ç›‘æ§ï¼šç£ç›˜ >= 90%ã€HTTP è¿æ¥ >= 50 çš„èŠ‚ç‚¹
> >
> > 4.æ‰‹åŠ¨é…ç½®ï¼šé€šè¿‡ Redis é…ç½®å‰”é™¤

>> æ¢å¤æœºåˆ¶ï¼š
> >
> > LoadingCache å®šæ—¶åˆ·æ–°ï¼ˆ1 åˆ†é’Ÿï¼‰ã€‚
> >
> > èŠ‚ç‚¹æ¢å¤å¥åº·åè‡ªåŠ¨ä»é»‘åå•ç§»é™¤ã€‚

![e4d189881f419d9f8446d8c705ff39d1](../e4d189881f419d9f8446d8c705ff39d1.png)


- å¼‚å¸¸å¤„ç†æ¨¡å¼
>> ä¸¤ç§ Sink æ¨¡å¼
```
public Sink buildSink(String targetTable, String targetCount, int maxBufferSize) {
    IClickHouseSinkBuffer buffer = ClickHouseShardSinkBuffer.Builder
        .aClickHouseSinkBuffer()
        .withTargetTable(targetTable)
        .withMaxFlushBufferSize(maxBufferSize)
        .withClickHouseShardStrategy(new LogClickHouseShardStrategy(targetTable, count))
        .build(clickHouseWriter);
    // æ ¹æ®é…ç½®é€‰æ‹©æ¨¡å¼
    if (ignoringClickHouseSendingExceptionEnabled) {
        return new UnexceptionableSink(buffer);  // å¿½ç•¥å¼‚å¸¸
    } else {
        return new ExceptionsThrowableSink(buffer); // æŠ›å‡ºå¼‚å¸¸
    }
}
```

>> UnexceptionableSinkï¼ˆå¿½ç•¥å¼‚å¸¸ - At-Most-Onceï¼‰

```

public class UnexceptionableSink implements Sink<LogModel> {
    private final IClickHouseSinkBuffer<LogModel> buffer;
    @Override
    public void put(LogModel message) {
        buffer.put(message);  // ä¸æ£€æŸ¥ Future çŠ¶æ€
    }
    @Override
    public void flush() {
        buffer.flush();
    }
}
```

>> é€‚ç”¨åœºæ™¯ï¼š
>> å…è®¸éƒ¨åˆ†æ•°æ®ä¸¢å¤±ã€‚
>>
>>ä¸å¸Œæœ›å› å†™å…¥å¼‚å¸¸å¯¼è‡´ä»»åŠ¡å¤±è´¥ã€‚
>>
>>å¯¹æ•°æ®å‡†ç¡®æ€§è¦æ±‚ä¸é«˜ï¼ˆå¦‚æ—¥å¿—ç»Ÿè®¡ï¼‰ã€‚
>>
>>è¯­ä¹‰ä¿è¯ï¼šAt-Most-Onceï¼ˆæœ€å¤šä¸€æ¬¡ï¼‰

>> ExceptionsThrowableSinkï¼ˆæŠ›å‡ºå¼‚å¸¸ - At-Least-Onceï¼‰

```

public class ExceptionsThrowableSink implements Sink<LogModel> {
    private final IClickHouseSinkBuffer<LogModel> buffer;
    @Override
    public void put(LogModel message) throws ExecutionException, InterruptedException {
        buffer.put(message);
        // æ¯æ¬¡å†™å…¥éƒ½æ£€æŸ¥ Future çŠ¶æ€
        buffer.assertFuturesNotFailedYet();
    }
    @Override
    public void flush() throws ExecutionException, InterruptedException {
        buffer.flush();
    }
}
```

>> Future çŠ¶æ€æ£€æŸ¥ï¼š
```

public void assertFuturesNotFailedYet() throws ExecutionException, InterruptedException {
    CompletableFuture<Void> future = FutureUtil.allOf(futures);
    // éé˜»å¡æ£€æŸ¥
    if (future.isCompletedExceptionally()) {
        logger.error("There is something wrong with the future. exist sink now");
        future.get(); // æŠ›å‡ºå¼‚å¸¸ï¼Œå¯¼è‡´ Flink ä»»åŠ¡å¤±è´¥
    }
}
```

>> é€‚ç”¨åœºæ™¯ï¼š

æ•°æ®å‡†ç¡®æ€§è¦æ±‚é«˜ã€‚

éœ€è¦ä¿è¯æ‰€æœ‰æ•°æ®å†™å…¥æˆåŠŸã€‚

å¼‚å¸¸æ—¶å¸Œæœ› Flink ä»»åŠ¡å¤±è´¥å¹¶é‡å¯ã€‚

è¯­ä¹‰ä¿è¯ï¼šAt-Least-Onceï¼ˆè‡³å°‘ä¸€æ¬¡ï¼‰

> Future æ¸…ç†ç­–ç•¥ä¸å¹¶å‘æ§åˆ¶
>> å®šæ—¶æ£€æŸ¥å™¨
```
public class ClickHouseSinkScheduledCheckerAndCleaner {
    private final ScheduledExecutorService scheduledExecutorService;
    private final List<CompletableFuture<Boolean>> futures;
    // âš ï¸ volatile ä¿è¯å¤šçº¿ç¨‹å¯è§æ€§ï¼ˆå…³é”®å¹¶å‘æ§åˆ¶ç‚¹ï¼‰
    private volatile boolean isFlushing = false;
    public ClickHouseSinkScheduledCheckerAndCleaner(...) {
        // å•çº¿ç¨‹å®šæ—¶æ‰§è¡Œå™¨
        scheduledExecutorService = Executors.newSingleThreadScheduledExecutor(factory);
        // å®šæ—¶æ‰§è¡Œæ¸…ç†ä»»åŠ¡ï¼ˆæ¯éš” checkTimeout ç§’ï¼Œé»˜è®¤ 30 ç§’ï¼‰
        scheduledExecutorService.scheduleWithFixedDelay(getTask(), ...);
    }
    private Runnable getTask() {
        return () -> {
            synchronized (this) {
                // ğŸ”’ å…³é”®ï¼šæ£€æŸ¥æ˜¯å¦æ­£åœ¨ flushï¼Œé¿å…å¹¶å‘å†²çª
                if (isFlushing) {
                    return; // Checkpoint æœŸé—´æš‚åœæ¸…ç†
                }
                // 1ï¸âƒ£ æ¸…ç†å·²å®Œæˆçš„ Future
                futures.removeIf(filter);
                // 2ï¸âƒ£ è§¦å‘æ‰€æœ‰ Buffer çš„ flushï¼ˆæ£€æŸ¥æ˜¯å¦éœ€è¦å†™å…¥ï¼‰
                clickHouseSinkBuffers.forEach(IClickHouseSinkBuffer::tryAddToQueue);
            }
        };
    }
    // Checkpoint flush å‰è°ƒç”¨ï¼ˆæš‚åœ cleanerï¼‰
    public synchronized void beforeFlush() {
        isFlushing = true;
    }
    // Checkpoint flush åè°ƒç”¨ï¼ˆæ¢å¤ cleanerï¼‰
    public synchronized void afterFlush() {
        isFlushing = false;
    }
}
```
>> æ ¸å¿ƒè®¾è®¡ï¼š

volatile boolean isFlushingï¼šæ ‡å¿—ä½ï¼Œåè°ƒ cleaner ä¸ checkpoint çº¿ç¨‹ã€‚

synchronized (this)ï¼šä¿è¯åŸå­æ€§ï¼Œé¿å…å¹¶å‘å†²çªã€‚

å•çº¿ç¨‹æ‰§è¡Œå™¨ï¼šé¿å… cleaner å†…éƒ¨å¹¶å‘é—®é¢˜ã€‚


> å¹¶å‘æ§åˆ¶æœºåˆ¶
>> é—®é¢˜åœºæ™¯ï¼š
![image_300](../image_300.png)

>> å…³é”®è®¾è®¡ç‚¹ï¼š

volatile ä¿è¯å¯è§æ€§ï¼šisFlushing ä½¿ç”¨ volatileï¼Œç¡®ä¿å¤šçº¿ç¨‹é—´çš„å¯è§æ€§ã€‚

synchronized ä¿è¯åŸå­æ€§ï¼šgetTask() æ•´ä¸ªæ–¹æ³•ä½“ä½¿ç”¨ synchronized (this)ã€‚

æ ‡å¿—ä½åè°ƒï¼šé€šè¿‡ isFlushing æ ‡å¿—å®ç°ä¸¤ä¸ªçº¿ç¨‹é—´çš„åè°ƒã€‚

finally ç¡®ä¿æ¢å¤ï¼šå³ä½¿ waitUntilAllFuturesDone() å¼‚å¸¸ï¼Œä¹Ÿä¼šåœ¨ finally ä¸­æ¢å¤ cleanerã€‚

>>é¿å…çš„å¹¶å‘é—®é¢˜ï¼š

æ•°æ®é‡å¤å†™å…¥ï¼šCleaner å’Œ Checkpoint åŒæ—¶ flushã€‚

Buffer çŠ¶æ€ä¸ä¸€è‡´ï¼šä¸€è¾¹æ¸…ç©ºä¸€è¾¹å†™å…¥ã€‚

Future æ¸…ç†å†²çªï¼šæ­£åœ¨ä½¿ç”¨çš„ Future è¢«æ¸…ç†ã€‚

>> æ€§èƒ½å½±å“ï¼š

Checkpoint flush æœŸé—´ï¼Œcleaner æš‚åœæ‰§è¡Œï¼ˆé€šå¸¸ 1-3 ç§’ï¼‰ã€‚

Cleaner è·³è¿‡çš„å‘¨æœŸä¼šåœ¨ä¸‹æ¬¡æ­£å¸¸æ‰§è¡Œæ—¶è¡¥å¿ã€‚

å¯¹æ•´ä½“ååå½±å“æå°ï¼ˆcleaner é—´éš”é€šå¸¸ 30 ç§’ï¼‰ã€‚

> Checkpoint è¯­ä¹‰ä¿è¯

>> ä¸ºä»€ä¹ˆ Checkpoint æ—¶å¿…é¡» Flushï¼Ÿ
>> ä¸ Flush çš„åæœ:
>> ä¸Flushå¯¼è‡´æ•°æ®æ°¸ä¹…ä¸¢å¤±:
![0aaddcd052f51767b639e6e067b72622](../0aaddcd052f51767b639e6e067b72622.png)

>> æ­£ç¡®åšæ³•
```

@Override
public void snapshotState(FunctionSnapshotContext context) throws Exception {
    logger.info("start doing snapshot. flush sink to ck");
    // 1. å…ˆ flush bufferï¼ˆå°†å†…å­˜æ•°æ®å†™å…¥ ClickHouseï¼‰
    if (sink != null) {
        sink.flush();
    }
    // 2. ç­‰å¾…æ‰€æœ‰å†™å…¥å®Œæˆ
    if (sinkManager != null && !sinkManager.isClosed()) {
        sinkManager.flush();
    }
    // æ­¤æ—¶ Checkpoint æ‰èƒ½æ ‡è®°ä¸ºæˆåŠŸ
    logger.info("doing snapshot. flush sink to ck");
}
```

>> Flush å®ç°ä¸å¹¶å‘åè°ƒ

```

public class ClickHouseSinkManager {
    public void flush() {
        // ğŸ”„ æ­¥éª¤1ï¼šæš‚åœå®šæ—¶æ¸…ç†ä»»åŠ¡
        clickHouseSinkScheduledCheckerAndCleaner.beforeFlush(); // isFlushing = true
        try {
            // ğŸ”„ æ­¥éª¤2ï¼šæ‰§è¡Œ buffer flush + ç­‰å¾…æ‰€æœ‰å†™å…¥å®Œæˆ
            clickHouseWriter.waitUntilAllFuturesDone(false, false);
        } finally {
            // ğŸ”„ æ­¥éª¤3ï¼šæ¢å¤å®šæ—¶æ¸…ç†ä»»åŠ¡ï¼ˆfinally ç¡®ä¿æ‰§è¡Œï¼‰
            clickHouseSinkScheduledCheckerAndCleaner.afterFlush(); // isFlushing = false
        }
    }
}
```

>> å¹¶å‘åè°ƒè¯¦è§£ï¼š
```

// cleaner çº¿ç¨‹æ‰§è¡Œæµç¨‹
synchronized (this) {
    if (isFlushing) {
        return; // Checkpoint æœŸé—´è·³è¿‡æœ¬æ¬¡æ‰§è¡Œ
    }
    // æ­£å¸¸æ‰§è¡Œï¼šæ¸…ç†å·²å®Œæˆçš„ Future + è§¦å‘ Buffer flush
    futures.removeIf(filter);
    buffers.forEach(Buffer::tryAddToQueue);
}
```

>> å…³é”®ç‚¹ï¼š

volatile å¯è§æ€§ï¼šisFlushing ä½¿ç”¨ volatile ç¡®ä¿ cleaner çº¿ç¨‹ç«‹å³çœ‹åˆ°çŠ¶æ€å˜åŒ–ã€‚

synchronizedäº’æ–¥ï¼šgetTask()æ–¹æ³•ä½“ä½¿ç”¨ synchronized (this) ç¡®ä¿åŸå­æ€§ã€‚

æ ‡å¿—ä½åè°ƒï¼šé€šè¿‡ beforeFlush() / afterFlush() ç®¡ç†æ ‡å¿—ä½ã€‚

finally ä¿è¯æ¢å¤ï¼šå³ä½¿ flush å¼‚å¸¸ï¼Œä¹Ÿä¼šåœ¨ finally ä¸­æ¢å¤ cleanerã€‚

>> ç­‰å¾…æ‰€æœ‰ Future å®Œæˆ
```
public synchronized void waitUntilAllFuturesDone(boolean stopWriters, boolean clearFutures) {
    try {
        // å¾ªç¯ç­‰å¾…ï¼šç›´åˆ°æ‰€æœ‰ Future å®Œæˆ + é˜Ÿåˆ—æ¸…ç©º
        while (!futures.isEmpty() || unProcessedCounter.get() > 0) {
            CompletableFuture<Void> all = FutureUtil.allOf(futures);
            // æœ€å¤šç­‰å¾… 3 åˆ†é’Ÿï¼ˆä¸ Future è¶…æ—¶ä¸€è‡´ï¼‰
            all.get(3, TimeUnit.MINUTES);
            // ç§»é™¤å·²å®Œæˆçš„ Futureï¼ˆéå¼‚å¸¸ï¼‰
            futures.removeIf(f -> f.isDone() && !f.isCompletedExceptionally());
            // æ£€æŸ¥æ˜¯å¦æœ‰å¼‚å¸¸ Future
            if (anyFutureFailed()) {
                break; // æœ‰å¼‚å¸¸åˆ™é€€å‡º
            }
        }
    } finally {
        if (stopWriters) stopWriters();
        if (clearFutures) futures.clear();
    }
}
```
>> å…³é”®é€»è¾‘ï¼š

å¾ªç¯ç­‰å¾…ç›´åˆ°æ‰€æœ‰ Future å®Œæˆ + é˜Ÿåˆ—æ¸…ç©ºã€‚

è¶…æ—¶ 3 åˆ†é’Ÿï¼ˆä¸ Future è¶…æ—¶ä¸€è‡´ï¼‰ã€‚

ç§»é™¤å·²å®Œæˆçš„éå¼‚å¸¸ Futureã€‚

æœ‰å¼‚å¸¸æ—¶é€€å‡ºå¾ªç¯ã€‚

>> ä¸‰ç§ Flush è§¦å‘æ–¹å¼å¯¹æ¯”:
![703cb65f7526e670f227362198cecbb6.jpg](file:///Users/wudy.yu/Library/Containers/com.tencent.xinWeChat/Data/Documents/xwechat_files/wxid_00fon257hiq81_f770/temp/RWTemp/2026-02/703cb65f7526e670f227362198cecbb6.jpg)

>> Checkpoint å‚æ•°é…ç½®
```
// Checkpoint é…ç½®å»ºè®®
StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();
// å¯ç”¨ Checkpointï¼ˆé—´éš” 1 åˆ†é’Ÿï¼‰
env.enableCheckpointing(60000);
// Checkpoint è¶…æ—¶ï¼ˆå¿…é¡»å¤§äº Future è¶…æ—¶ + é‡è¯•æ—¶é—´ï¼‰
// å»ºè®®ï¼šCheckpointTimeout > FutureTimeout * MaxRetries
env.getCheckpointConfig().setCheckpointTimeout(600000); // 10 åˆ†é’Ÿ
// ä¸€è‡´æ€§æ¨¡å¼
env.getCheckpointConfig().setCheckpointingMode(CheckpointingMode.EXACTLY_ONCE);
// æœ€å°é—´éš”ï¼ˆé¿å…è¿‡äºé¢‘ç¹ï¼‰
env.getCheckpointConfig().setMinPauseBetweenCheckpoints(30000); // 30 ç§’
// æœ€å¤§å¹¶å‘ Checkpoint æ•°
env.getCheckpointConfig().setMaxConcurrentCheckpoints(1);
```

- è¯­ä¹‰ä¿è¯
![image_301](../image_301.png)

>> æ¨èé…ç½®ï¼š

ç”Ÿäº§ç¯å¢ƒï¼šä½¿ç”¨ ExceptionsThrowableSink + Checkpointã€‚

å…è®¸éƒ¨åˆ†ä¸¢å¤±ï¼šä½¿ç”¨ UnexceptionableSinkã€‚


- æœ€ä½³å®è·µä¸è°ƒä¼˜
>> ç”Ÿäº§é…ç½®

```
// ========== ClickHouse è¿æ¥å‚æ•° ==========
clickhouse.sink.target-table = tb_logs_local
clickhouse.sink.max-buffer-size = 104857600        // æ‰¹æ¬¡å¤§å°
clickhouse.sink.table-count = 0                // 0 è¡¨ç¤ºä¸åˆ†è¡¨
// ========== å†™å…¥æ€§èƒ½å‚æ•° ==========
clickhouse.sink.num-writers = 10               // å†™å…¥çº¿ç¨‹æ•°
clickhouse.sink.queue-max-capacity = 10        // é˜Ÿåˆ—å®¹é‡
clickhouse.sink.timeout-sec = 30               // flush è¶…æ—¶
clickhouse.sink.retries = 10                   // æœ€å¤§é‡è¯•æ¬¡æ•°
clickhouse.sink.check.timeout-sec = 30         // å®šæ—¶æ£€æŸ¥é—´éš”
// ========== å¼‚å¸¸å¤„ç†å‚æ•° ==========
clickhouse.sink.ignoring-clickhouse-sending-exception-enabled = false
clickhouse.sink.local-address-enabled = true   // å¯ç”¨æœ¬åœ°è¡¨å†™å…¥
// ========== ClickHouse é›†ç¾¤é…ç½® ==========
clickhouse.access.hosts = 192.168.1.1:8123,192.168.1.2:8123,192.168.1.3:8123
clickhouse.access.user = default
clickhouse.access.password = ***
clickhouse.access.database = dw_xx_xx
clickhouse.access.cluster = default
// ========== HikariCP è¿æ¥æ± é…ç½® ==========
connectionTimeout = 30000                      // è¿æ¥è¶…æ—¶ 30s
maximumPoolSize = 20                           // æœ€å¤§è¿æ¥æ•° 20
minimumIdle = 2                                // æœ€å°ç©ºé—² 2
socket_timeout = 180000                        // Socket è¶…æ—¶ 3mi
```

>> æ€§èƒ½è°ƒä¼˜
![image_302](../image_302.png)

>> æ•…éšœæ’æŸ¥
![image_303](../image_303.png)

- æ€»ç»“

>> æœ¬æ–‡æ·±å…¥åˆ†æäº† Flink ClickHouse Sink çš„å®ç°æ–¹æ¡ˆï¼Œæ ¸å¿ƒäº®ç‚¹åŒ…æ‹¬:
>> 1.è¿æ¥æ± é€‰å‹ï¼šä½¿ç”¨ HikariCPï¼Œæ€§èƒ½ä¼˜å¼‚ï¼Œè¿æ¥ç®¡ç†å¯é ã€‚
>>
>> 2.Future è¶…æ—¶æ§åˆ¶ï¼šorTimeout(3min) é˜²æ­¢æ°¸ä¹…é˜»å¡ã€‚
>>
>> 3.æ˜¾å¼èµ„æºç®¡ç†ï¼šConnection å’Œ PreparedStatement æ˜¾å¼å…³é—­ï¼Œé˜²æ­¢è¿æ¥æ³„æ¼ã€‚
>>
>> 4.è´Ÿè½½å‡è¡¡ä¼˜åŒ–ï¼šShuffle åˆå§‹åŒ– + è½®è¯¢é€‰æ‹©ï¼Œé¿å…çƒ­ç‚¹ã€‚
>>
>> 5.å¼‚å¸¸å¤„ç†å¢å¼ºï¼šfuture.isDone() æ£€æŸ¥ï¼Œé¿å…é‡å¤å®Œæˆã€‚
>>
>> 6.æœ¬åœ°è¡¨å†™å…¥ï¼šåŠ¨æ€èŠ‚ç‚¹å‘ç° + æ•…éšœå‰”é™¤ï¼Œå†™å…¥æ€§èƒ½æå‡ã€‚
>>
>> 7.åˆ†ç‰‡ç­–ç•¥ï¼šæŒ‰è¡¨ï¼ˆåº”ç”¨ï¼‰ç»´åº¦è·¯ç”±ï¼Œç‹¬ç«‹ç¼“å†²å’Œéš”ç¦»ã€‚
>>
>> 8.æ”’æ‰¹ä¼˜åŒ–ï¼šåŒè§¦å‘æœºåˆ¶ï¼ˆå¤§å° + è¶…æ—¶ï¼‰+ éšæœºæŠ–åŠ¨ã€‚
>>
>> 9.æµé‡æ§åˆ¶ï¼šæœ‰ç•Œé˜Ÿåˆ— + çº¿ç¨‹æ± ï¼Œå®ç°èƒŒå‹ã€‚
>>
>> 10.å¥å£®é‡è¯•ï¼šé€’å½’é‡è¯• + å¼‚å¸¸èŠ‚ç‚¹å‰”é™¤ + æœ€å¤§é‡è¯•é™åˆ¶

- Checkpoint è¯­ä¹‰
>> At-Least-Onceï¼šExceptionsThrowableSink + Checkpointã€‚
>>
>>At-Most-Onceï¼šUnexceptionableSinkã€‚
>>
>>Exactly-Onceï¼šéœ€è¦é…åˆ ClickHouse äº‹åŠ¡ï¼ˆæœªå®ç°ï¼‰ã€‚

- ç”Ÿäº§å»ºè®®
>> 1.å¿…é¡»ï¼šCheckpoint æ—¶ flushï¼Œå¦åˆ™ä¼šä¸¢æ•°æ®ã€‚
>>
>>2.æ¨èï¼šä½¿ç”¨ HikariCP + æœ¬åœ°è¡¨å†™å…¥ã€‚
>>
>> 3.æ¨èï¼šé…ç½®åˆç†çš„è¶…æ—¶ï¼ˆFuture < Socket < Checkpointï¼‰ã€‚
>>
>> 4.æ¨èï¼šç›‘æ§é˜Ÿåˆ—å¤§å°ã€Future å¤±è´¥ç‡ã€é‡è¯•æ¬¡æ•°ã€‚
>>
>> 5.è¯¥æ–¹æ¡ˆå·²åœ¨ç”Ÿäº§ç¯å¢ƒå¤§è§„æ¨¡éªŒè¯ï¼Œèƒ½å¤Ÿç¨³å®šæ”¯æ’‘ç™¾ä¸‡çº§ TPS çš„æ—¥å¿—å†™å…¥åœºæ™¯ã€‚

























































































































































